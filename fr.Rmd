---
params: 
  title: ""
  publication_date: ""
  doi: ""
  year_in_title: "Avril 2022"
  recent_calls: ["Octobre 2021", "Avril 2022"]
  up_to_date: ["2022-05-01"]
  since: ["2013-10-01"]
  research_area: "all"
  confounders_odds_ssh: ["InstType", "FirstProject", "scale_age"]
  confounders_odds_mint: ["InstType", "FirstProject", "scale_age"]
  confounders_odds_ls: ["InstType", "FirstProject", "scale_age"]
output: 
  html_document:
    anchor_sections: false
    theme: null
    highlight: null
    mathjax: null
    css: ["style.css", "https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap"]
    self_contained: true
title: "`r params$title`"
---

```{r general-setup, include=FALSE}
## This file contains the FRENCH version of the data story 

# Set general chunk options
knitr::opts_chunk$set(echo = FALSE, fig.showtext = TRUE, fig.retina = 3, 
                      fig.align = "center", warning = FALSE, message = FALSE)

# Install snf.datastory package if not available, otherwise load it
if (!require("snf.datastory")) {
  if (!require("devtools")) {
    install.packages("devtools")
    library(devtools)
  }
  install_github("snsf-data/snf.datastory")
  library(snf.datastory)
}

# Load packages
library(tidyverse)
library(lubridate)
library(scales)
library(conflicted)
library(jsonlite)
library(here)
library(ggiraph)
library(readr)
library(kableExtra)
library(stringi)
library(lme4)
library(splines)
library(glue)

# Conflict preferences
conflict_prefer("filter", "dplyr")
conflict_prefer("get_datastory_theme", "snf.datastory")
conflict_prefer("get_datastory_scheme", "snf.datastory")

# Increase showtext package font resolution
showtext_opts(dpi = 320)

# Set the locale for date formatting (Windows)
Sys.setlocale("LC_TIME", "French")

# Create function to print number with local language-specific format 
print_num <- function(x) snf.datastory::print_num(x, lang = "fr")

# Knitr hook for local formatting of printed numbers
knitr::knit_hooks$set(
  inline <- function(x) {
    if (!is.numeric(x)) {
      x
    } else {
      print_num(x)
    }
  }
)
```

```{r print-header-infos, results='asis'}
# Add publication date to header
cat(format(as_datetime(params$publication_date), "%d.%m.%Y"))

# Register the Google font (same as Data Portal, is not loaded twice)
cat(paste0("<link href='https://fonts.googleapis.com/css?family=", 
           "Source+Sans+Pro:400,700&display=swap' rel='stylesheet'>"))
```

```{r story-specific-setup, include=FALSE, message=FALSE}
# Init local variables with params
recent_calls <- params$recent_calls
up_to_date <- params$up_to_date
since <- params$since
research_area <- params$research_area
confounders_odds_ssh <- params$confounders_odds_ssh
confounders_odds_mint <- params$confounders_odds_mint
confounders_odds_ls <- params$confounders_odds_ls
confounders_odds <- unique(c(
  confounders_odds_ls,
  confounders_odds_ssh,
  confounders_odds_mint
))

# Load data required to calculate the models
data_gm_up_to_year_of_interest <- 
  read_csv("data_gm_up_to_year_of_interest_oct22.csv") %>%
  # Lang-specific recoding & orderings
  mutate(
    Call = str_replace_all(Call, "October", "Octobre"), 
    Call = str_replace_all(Call, "April", "Avril"),
    # Switch the order of the year and month name for de/fr
    Call = map_chr(Call, function(x) {
      x %>% 
        str_split(" ") %>% 
        unlist() %>% 
        rev() %>% 
        paste0(collapse = " ")
    }), 
    InstType = case_when(
      InstType == "ETH" ~ "Domaines des EPF", 
      InstType == "Cantonal universities" ~ "Universités cantonales", 
      InstType == "UAS/UTE" ~ "HES/HEP", 
      InstType == "Other" ~ "Autres", 
      TRUE ~ "UNKNOWN"
    ), 
    InstType = fct_relevel(InstType, c(
      "Universités cantonales", "Domaines des EPF", "HES/HEP", "Autres"
    )),
    Division = translate_research_area(Division, target_lang = "fr"), 
    Division = fct_relevel(Division, c("Général", "SHS", "MINT", "SV"))
  ) 

# We run the statistical model first on the x latest calls:
data_recent <- data_gm_up_to_year_of_interest %>%
  filter(grepl(paste(recent_calls, collapse = "|"), Call)) %>%
  droplevels()

switch_order <- function(str) {
  idx_month <- seq(2, (length(str) * 2), by = 2)
  idx_year <- seq(1, (length(str) * 2), by = 2)
  str_month <- unlist(str_split(str, " "))[idx_month]
  str_year <- unlist(str_split(str, " "))[idx_year]
  paste0(str_month, " ", str_year)
}

call_names <- data_gm_up_to_year_of_interest %>%
  count(Call) %>%
  pull(Call) %>%
  switch_order()

# Calculate the number of submissions per Year / per Call
nb_application_by_year <- data_gm_up_to_year_of_interest %>%
  group_by(year(CallEndDate)) %>%
  summarise("Total number of submissions" = n()) %>%
  rename("Call Year" = `year(CallEndDate)`) %>%
  ungroup()

nb_application_by_call <- data_gm_up_to_year_of_interest %>%
  group_by(Call) %>%
  summarise("Total number of submissions" = n()) %>%
  ungroup()

plot_by_division <- function(div, limits = c(0.18, .87),
                             title = NULL, xlab = NULL, ylab = NULL,
                             inverse_gender = FALSE, allpooled = allpooled,
                             add_overall = FALSE) {
  # Subset division when required
  if (div != "all") {
    toplot <- toplot %>%
      filter(Division == div)
  }
  
  # When one plot "Overall" should be added
  if (add_overall) {
    toplot <- toplot %>%
      bind_rows(allpooled %>%
                  mutate(Division = "Général")) %>% 
      mutate(Division = fct_relevel(Division, 
                                    c("Général", "SHS", "MINT", "SV")))
  }
  
  # Ordering
  toplot <- toplot %>%
    mutate(Division = fct_relevel(Division, 
                                  c("Général", "SHS", "MINT", "SV")))
  
  # Every second element to display
  calls_to_display <- toplot %>% 
    ungroup() %>% 
    distinct(Call, CallEndDate) %>% 
    arrange(CallEndDate) %>% 
    pull(Call)
  calls_to_display <- calls_to_display[seq(1, length(calls_to_display), 2)]
  
  # Translate
  toplot <- toplot %>% 
    mutate(Gender = case_when(Gender == "Female" ~ "Femmes", 
                              Gender == "Male" ~ "Hommes", 
                              TRUE ~ "UNKNOWN"))
  
  
  # Create the plot
  p <- toplot %>%
    ggplot(
      mapping =
        aes(
          x = reorder(Call, CallEndDate), y = first_time, group = Gender, color = Gender,
          tooltip = glue(
            "<b>{Division}</b>, {Call}<br>",
            "{round(100*first_time)}% {Gender}"
          ),
          data_id = rownames(.)
        )
    ) +
    geom_line(size = 0.5) +
    geom_point_interactive(size = 2) +
    # expand_limits(x = c(-.5, length(unique(allpooled$Call)) + 1.5)) +
    labs(title = title, x = xlab, y = ylab) +
    scale_colour_manual(values = get_datastory_scheme(), "") +
    scale_y_continuous(labels = scales::percent, limits = limits) +
    get_datastory_theme(tick_axis = "x", gridline_axis = "y") +
    scale_x_discrete(breaks = calls_to_display) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 8),
      axis.title.x = element_text(size = 10),
      axis.title.y = element_text(size = 10)
    )
  
  # When we're plotting all divisions, we facet-wrap
  if (div == "all") {
    p <- p +
      facet_wrap(~Division)
  }
  make_ggiraph(p)
}

# Function to plot OR trends over years
plot_OR_trends <- function(model, number_years,
                           dummy_variables = 1,
                           ylab = "Odds Ratio",
                           xlab = "Time", lwd = 2,
                           ylim = c(0, 2), lty = 1, col = 1,
                           axisticks = NULL, at = NULL,
                           add = FALSE,
                           print = TRUE, ci = FALSE,
                           mixed = FALSE, title = NULL,
                           cex.call = .75) {
  # We first extract the design matrix from a model: valid for mixed and fixed
  # effects models
  design <-
    stats::model.matrix(model)
  
  # However since we are only interested in the effect of GENDER, we only want
  # X to include non-0 for the gender-column and the columns with the
  # interactions of gender and year!
  
  # Now we create this dummy data to 'predict' from:
  
  # 1. we collect the spline columns:
  dummydat_year_part <-
    unique(design[, 2:(number_years)])
  # start at 2, because we do not need the intercept.
  
  # 2.
  # the first part of the dummy data matrix will only be zeros: the 'intercepts'
  #         --> actual intercept + year effects
  # and then we will add the default values of the variables
  #      (1 for Gender, and 0 for all the others)
  dummydat_first_with_vars <-
    # To a matrix with only 0, the intercept and the year effects will not be 
    # used...
    cbind(matrix(0,
                 ncol = number_years,
                 nrow = nrow(dummydat_year_part)
    ), dummy_variables[1])
  # First variable, 'initializing' the matrix
  # if there are more confounders used:
  if (length(dummy_variables) > 1) {
    for (i in 1:(length(dummy_variables) - 1)) {
      dummydat_first_with_vars <-
        cbind(dummydat_first_with_vars, dummy_variables[1 + i])
    }
  }
  
  # 3. Bind all the matrices, and add the year part at the end.
  dummydat_all <- # this adds the time-gender-interaction terms at the end
    cbind(dummydat_first_with_vars, dummydat_year_part)
  # Only works like this because we are interested in GENDER == 1 == female!
  # in the case of a continuous variable we would need to multiply the matrix
  
  # Then we extract the coefficient vector:
  if (mixed) {
    coefs <- fixef(model)
  } else {
    coefs <- coefficients(model)
  }
  # And compute the linear predictor : beta * X
  linpred <- dummydat_all %*% coefs
  or <- exp(linpred[, 1]) # Odds ratio
  # Then the 95%-Wald confidence intervals are computed as:
  if (ci) {
    if (mixed) {
      var_beta <- as.matrix(summary(model)$vcov)
    } else {
      var_beta <- summary(model)$cov.unscaled
    }
    se_linpred <- sapply(1:nrow(dummydat_all), function(i) {
      sqrt(dummydat_all[i, ] %*% var_beta %*% dummydat_all[i, ])
    })
    # ci_or <- exp(data.frame(lower_limit = linpred - 2.55 * se_linpred,
    #                         upper_limit = linpred + 2.55 * se_linpred))
    ci_or <- exp(data.frame(
      lower_limit = linpred - 1.96 * se_linpred,
      upper_limit = linpred + 1.96 * se_linpred
    ))
  }
  
  # The print of the OR (together with the CI)
  if (print) {
    if (ci) {
      print(data.frame(
        lower_limit = ci_or$lower_limit,
        or = exp(linpred[, 1]),
        upper_limit = ci_or$upper_limit
      ))
    } else {
      print(or)
    }
  }
  
  # The actual plot:
  if (add) { # should the OR be added to an already existing plot?
    lines(or, lty = lty, col = col, lwd = lwd)
    if (ci) {
      lines(ci_or$lower_limit, lty = 3, col = col, lwd = lwd)
      lines(ci_or$upper_limit, lty = 3, col = col, lwd = lwd)
    }
  } else {
    xaxt <- ifelse(is.null(axisticks), "s", "n") 
    plot(or,
         type = "b",
         ylim = ylim, lty = lty, col = col,
         ylab = ylab, xlab = xlab, xaxt = xaxt, lwd = lwd,
         main = title
    )
    if (ci) {
      lines(ci_or$lower_limit, lty = 3, col = col, lwd = lwd)
      lines(ci_or$upper_limit, lty = 3, col = col, lwd = lwd)
    }
    abline(h = 1, lty = 2, col = "gray")
    if (!is.null(axisticks)) {
      axis(1, labels = FALSE, at = at, las = 2)
      text(at, par("usr")[3] - 0.2,
           labels = axisticks,
           srt = 45, pos = 1, xpd = TRUE, cex = cex.call
      )
    }
  }
}
```

__Les disparités observées dans les subsides alloués par le FNS selon le genre des personnes requérantes peuvent s’expliquer par diverses influences directes et indirectes : coup d'œil sur les facteurs confondants qui peuvent fausser les résultats des analyses.__

Institution qui vit et promeut l’égalité des chances, le FNS s’efforce de soutenir les chercheuses et les chercheurs de tous horizons. Dans ce but, une série d’analyses périodiques a été mise en place afin d’étudier le rôle du genre dans la notation des requêtes déposées et les subsides accordés dans le cadre de l’encouragement de projets du FNS. Entre autres méthodes, ces analyses utilisent des modèles de régression pour évaluer les taux de réussite et les notes en fonction du genre de la personne requérante. Pour une interprétation fiable des résultats, il convient de veiller à ce que le modèle utilisé comprenne les variables confondantes appropriées. À défaut, les conclusions tirées peuvent varier considérablement.

### Type d’institution, première requête et âge de la personne requérante

<a href="https://data.snf.ch/stories/femmes-sous-representees-ou-sous-financees-fr.html" target="_blank">Le premier récit de données dans la série du FNS dédiée au monitoring de l’égalité entre les genre</a> présente les taux de réussite des requêtes déposées selon le genre de la personne requérante chargée de la correspondance (c’est-à-dire la personne responsable de la soumission du projet, décrit ci-après comme personne requérante). Il est toutefois difficile de quantifier avec précision la force avec laquelle le genre de la personne requérante et le succès du financement sont associés en s’aidant des taux de succès bruts, entre autres parce que ces derniers ne tiennent pas compte des variables confondantes. Les modèles de régression, en revanche, y parviennent. D’où leur utilisation dans le cadre de la présente analyse.

<div class='info-box'>

__Qu’est-ce qu’une variable confondante ?__

Une variable confondante est un élément en mesure d’influencer à la fois les résultats d’une analyse (en l’espèce, l’obtention de subsides) et la variable dont on essaye d’interpréter l’effet (dans ce cas-ci, le genre). Pour comprendre l’importance de ces variables confondantes, imaginons que nous voulions évaluer l’association entre la consommation d’alcool et le cancer. Considérons également qu’il a été démontré que fumer du tabac augmentait le risque de cancer du poumon, et qu’il existe une forte corrélation entre consommation de tabac et d’alcool. Dès lors, une modélisation statistique de la survenue d’un cancer du poumon fondée sur la consommation d’alcool comme seule variable explicative produirait des résultats hautement significatifs, établissant ainsi à tort que la consommation d’alcool serait à l’origine du cancer du poumon. Néanmoins, si on inclut dans le modèle la variable confondante de la consommation ou non de tabac, la portée statistique et l’effet de l’alcool sur le cancer du poumon seraient nettement réduits, voire éliminés. Grâce à l’analyse de variables confondantes, nous sommes à même d’identifier et d’évaluer les associations correctes, dotées d’une plus grande pertinence. En d’autres termes, les variables confondantes sont associées aussi bien à l’exposition anticipée qu’aux résultats obtenus, et peuvent fortement modifier (masquer ou accentuer) les résultats d’un modèle. C’est pourquoi il convient de toujours les intégrer au modèle statistique utilisé.
</div>

Notre attention se porte sur plusieurs variables confondantes potentielles, c.-à-d. des variables associées à la fois au genre de la personne requérante et à l’approbation du financement. L’une d’elles est le type d’institution auquel la personne requérante est affiliée. Le premier graphique ci-dessous présente la part de requérantes et de requérants selon le type d’institution de recherche auquel il ou elle est affilié·e. On constate que les requérantes sont davantage issues de hautes écoles spécialisées ou de hautes écoles pédagogiques que leurs homologues masculins, tandis que ces derniers travaillent souvent dans des institutions du domaine des EPF. Des analyses antérieures ayant démontré que les requêtes en provenance d’institutions du domaine des EPF présentaient une probabilité accrue de financement par le FNS, il apparaît que le type d’institution est associé tant avec le taux de succès qu’avec le genre de la personne requérante. 

Par ailleurs, des analyses antérieures ont également révélé que le taux de succès des personnes déposant une première requête est inférieur à celui des chercheuses et chercheurs qui n’en sont pas à leur coup d’essai. Des analyses internes ont également établi que le taux de réussite des jeunes requérant·es tend à être plus faible. Le deuxième graphique fait clairement apparaître que les femmes sont majoritaires parmi les personnes déposant une première requête. Ainsi, ne pas tenir compte de ces variables confondantes pourrait fortement fausser les résultats d’un modèle statistique et augmenter ou masquer artificiellement l’effet et l’importance du genre sur les taux de réussite.


```{r overall-sr, include=FALSE}
# Function to create ggiraph object
make_ggiraph <- function(ggobj) {
  girafe(
    ggobj = ggobj,
    height_svg = 4,
    options = list(
      opts_toolbar(saveaspng = FALSE),
      opts_hover(css = "fill:#ff0000;stroke:#000000;"),
      opts_tooltip(
        css = get_ggiraph_tooltip_css(),
        opacity = 0.8,
        delay_mouseover = 0,
        delay_mouseout = 0
      )
    )
  )
}

# Summarize female and male corr. applicant shares by insttution type
plot_data <- data_gm_up_to_year_of_interest %>%
  filter(!is.na(Call)) %>%
  filter(Gender == "Female") %>%
  group_by(Call, CallEndDate) %>%
  mutate(N = n()) %>%
  ungroup() %>%
  group_by(InstType, Call, CallEndDate) %>%
  summarise(perc = n() / head(N, 1)) %>%
  ungroup() %>%
  mutate(type = "Femmes requérantes") %>%
  bind_rows(data_gm_up_to_year_of_interest %>%
              filter(!is.na(Call)) %>%
              filter(Gender == "Male") %>%
              group_by(Call, CallEndDate) %>%
              mutate(N = n()) %>%
              ungroup() %>%
              group_by(InstType, Call, CallEndDate) %>%
              summarise(perc = n() / head(N, 1)) %>%
              ungroup() %>%
              mutate(type = "Hommes requérants")) %>% 
  mutate(type = fct_relevel(type, 
                            c("Femmes requérantes", 
                              "Hommes requérants")))

# Every second element to display
calls_to_display <- plot_data %>% 
  ungroup() %>% 
  distinct(Call, CallEndDate) %>% 
  arrange(CallEndDate) %>% 
  pull(Call)
calls_to_display <- calls_to_display[seq(1, length(calls_to_display), 2)]

p0_female_male <- plot_data %>%
  ggplot(aes(
    x = reorder(Call, CallEndDate), y = perc, color = InstType, 
    group = InstType,
    tooltip = glue(
      "<b>{InstType}</b>, {Call}<br>{round(100*perc)}%",
      " {type}"
    ), data_id = rownames(.)
  )) +
  geom_line(size = 0.5) +
  geom_point_interactive(size = 2) +
  expand_limits(x = c(-.5, length(unique(plot_data$Call)) + 1.5)) +
  labs(x = NULL, y = "Proportion de requérant-e-s\n") +
  scale_y_continuous(labels = scales::percent, limits = c(0, .9)) +
  scale_color_manual(values = get_datastory_scheme(), "") +
  get_datastory_theme(gridline_axis = "y") +
  scale_x_discrete(breaks = calls_to_display) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    legend.direction = "horizontal"
  ) +
  facet_wrap(~type, nrow = 1)
```

```{r first-time, include=FALSE}
allpooled_ft <- data_gm_up_to_year_of_interest %>%
  filter(!is.na(Call)) %>%
  group_by(Gender, Call, CallEndDate) %>%
  summarise(first_time = mean(FirstProject == TRUE, na.rm = TRUE)) %>%
  ungroup()

toplot <- data_gm_up_to_year_of_interest %>%
  filter(!is.na(Call)) %>%
  group_by(Division, Gender, Call, CallEndDate) %>%
  summarise(first_time = mean(FirstProject == TRUE, na.rm = TRUE))

p1 <- plot_by_division(
  div = "all", inverse_gender = TRUE,
  title = NULL, xlab = NULL, limits = c(0, .5),
  allpooled = allpooled_ft,
  ylab = "Proportion de nouveaux et nouvelles requérant·es\n", add_overall = TRUE
)
```

<div class="plot-box">

<div class="hide-mobile hide-tablet widemedia">
<div class="plot-title">Part de requérantes et de requérants selon le type d’institution dans le temps</div>
```{r p0-desktop}
make_ggiraph(p0_female_male)
```
<div class="caption">
Part de requérantes et de requérants selon le type d’institution dans l’encouragement de projets du FNS sur la période d'octobre 2013 à avril 2022 (HES/HEP : hautes écoles spécialisées / hautes écoles pédagogiques).
</div>
<div class="plot-title">Part de requérantes et de requérants déposant une première requête selon le domaine de recherche dans le temps</div>
```{r p1-desktop}
p1
```
<div class="caption">
Part de requérantes et de requérants déposant une première requête selon le domaine de recherche dans l’encouragement de projets du FNS sur la période d'octobre 2013 à avril 2022 (SHS : sciences humaines et sociales ; MINT : mathématiques, sciences naturelles et ingénierie ; SV : sciences de la vie).
</div>
</div>

<div class="hide-desktop">
<div class="plot-title">Part de requérantes et de requérants selon le type d’institution dans le temps</div>
```{r p0-mobile}
make_ggiraph(p0_female_male)
```
<div class="caption">
Part de requérantes et de requérants selon le type d’institution dans l’encouragement de projets du FNS sur la période d'octobre 2013 à avril 2022 (HES/HEP : hautes écoles spécialisées / hautes écoles pédagogiques).
</div>
<div class="plot-title">Part de requérantes et de requérants déposant une première requête selon le domaine de recherche dans le temps</div>
```{r p1-mobile}
p1
```
<div class="caption">
Part de requérantes et de requérants déposant une première requête selon le domaine de recherche dans l’encouragement de projets du FNS sur la période d'octobre 2013 à avril 2022 (SHS : sciences humaines et sociales ; MINT : mathématiques, sciences naturelles et ingénierie ; SV : sciences de la vie).
</div>
</div>
</div>

### Résultats ajustés et résultats non ajustés

Afin d’étudier l’allocation de subsides en fonction du genre, nous modélisons la décision de financement au niveau de chaque proposition. Nous corrigeons les modèles de régression logistique afin d’analyser ces résultats binaires (allocation ou non-allocation de subsides). Par modèle de régression, on entend une estimation statistique de la relation entre une variable dépendante (allocation ou non-allocation de subsides) et une ou plusieurs variables explicatives prédictives. En régression logistique, le résultat est binaire. Cette méthode ne constitue pas une mesure directe des taux de succès ; elle nous permet davantage de mesurer la probabilité d’allocation de subsides. L’effet des facteurs qui influencent la probabilité de réussite est ensuite mesuré au moyen de rapports des chances (RC).

<div class='info-box'>

__Probabilité de réussite, rapports des chances et intervalles de confiance__

Le rapport des chances est le quotient de la probabilité de réalisation d’un évènement présentant un intérêt par la probabilité de réalisation de tout évènement autre que celui présentant un intérêt. Prenons l’exemple d’un lancer de dé à six faces : le rapport des chances traduisant la probabilité d’obtenir un six est de 1/6 divisé par 5/6, soit 1/5 (ou 0,2). Nous pourrions aussi calculer le quotient de la probabilité d’obtenir un six en serrant son porte-bonheur (évènement présentant un intérêt) par la probabilité d’obtenir un six sans serrer son porte-bonheur (évènement ne présentant pas d’intérêt). Un rapport des chances peut prendre toute valeur entre zéro et l’infini. Un rapport des chances de 1 implique que les deux événements ont des chances égales ; signifiant donc que le facteur analysé (par exemple, le fait de serreur son porte-bonheur) n’a aucun effet. Les estimations statistiques telles que les rapports des chances s’accompagnent d’intervalles de confiance (IC) qui quantifient les incertitudes liées à une estimation donnée. Plus précisément, un intervalle de confiance à 95 % définit la plage dans laquelle l’estimation du facteur analysé  devrait se réaliser 95 % du temps, si l’expérience était répétée. Pour  un rapport des chances, un intervalle de confiance comprenant la valeur de 1 traduit une estimation statistiquement négligeable, tandis qu’un intervalle ne comprenant pas la valeur de 1 traduit un résultat statistiquement significatif.

</div>

Dans notre cas, nous souhaitons voir si les probabilités de réussite sont différentes pour les requérantes et requérants. Les rapports des chances figurant dans le tableau ci-dessous ont été calculés sur la base des deux derniers appels évalués, et ce séparément pour chaque domaine de recherche. Les versions non ajustées ne tiennent pas compte des variables confondantes (âge, requête antérieure et type d’institution), alors que les versions ajustées en tiennent compte. Par exemple, le rapport des chances non ajusté entre les genres en sciences humaines est de 1,15, c’est-à-dire que pour les femmes, la probabilité que leur proposition soit financée est 1,15 fois supérieure à celle des hommes. Comme l’intervalle de confiance (IC) à 95 % correspondant contient la valeur de 1, cet effet de genre n'est pas considéré comme statistiquement significatif. Dans les deux autres domaines de recherche, les chances d'obtenir un financement sont à peu près égales pour les candidats féminins et masculins dans les modèles non ajustés. Cependant, les rapport des chances ajustés sont plus élevés que ceux non ajustés, ce qui indique que les candidates ont plus de chances d'obtenir un financement du FNS que les candidats, après ajustement des facteurs confondants. Cependant, les effets observés sont tous proches de 1 (c’est-à-dire plutôt de faible ampleur) et ne sont pas statistiquement significatifs.

```{r, include=FALSE, eval=FALSE}
data_gm_up_to_year_of_interest %>%
  count(IsApproved, Gender, FirstProject) %>%
  group_by(FirstProject, Gender) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = FirstProject, y = prop, fill = Gender)) +
  geom_col(position = position_dodge()) +
  facet_wrap(~IsApproved, nrow = 2)

data_gm_up_to_year_of_interest %>%
  count(IsApproved, Gender, InstType) %>%
  group_by(InstType, Gender) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = InstType, y = prop, fill = Gender)) +
  geom_col(position = position_dodge()) +
  facet_wrap(~IsApproved, nrow = 2)
```


<div class="plot-box">
<div class="plot-title">Rapports de chances ajustés et non ajustés associés au genre des requérant·es (avec un intervalle de confiance à 95 %), par domaine de recherche, sur la base de modèles de régression logistique appliqués aux deux plus récents appels à projets évalués (avril et octobre 2021).</div>

```{r}
data_recent <- data_recent %>%
  mutate(Gender = factor(Gender, levels = c("Male", "Female")))

# Formula for computation of models for Odds ratio trends (adjusted)
form <- sapply(
  list(
    confounders_odds_ssh,
    confounders_odds_mint,
    confounders_odds_ls
  ),
  function(conf) {
    paste0("IsApproved ~ Gender + ", paste0(conf, collapse = " + "))
  }
)

divisions <- c("SHS", "MINT", "SV")

# Unadjusted model stratified by research area
unadjusted_fit_recent <- lapply(1:3, function(i) {
  data_subset <- data_recent %>%
    filter(Division == divisions[i])
  return(glm(IsApproved ~ Gender, family = "binomial", data = data_subset))
})
names(unadjusted_fit_recent) <- divisions

# Adjusted model stratified by research area
adjusted_fit_recent <- lapply(1:3, function(i) {
  data_subset <- data_recent %>%
    filter(Division == divisions[i])
  return(glm(form[i], family = "binomial", data = data_subset))
})
names(adjusted_fit_recent) <- divisions

# Put the results in nice tables:
results_summary_table <- function(fit) {
  tmp <-
    data.frame(
      Division = names(fit),
      OR = format(exp(sapply(1:3, function(i) {
        coefficients(fit[[i]])["GenderFemale"]
      })),
      digits = 2,
      nsmall = 2
      ),
      CI = sapply(1:3, function(i) {
        paste(
          format(exp(confint(fit[[i]])["GenderFemale", 1]),
                 digits = 2, nsmall = 2
          ), "to",
          format(exp(confint(fit[[i]])["GenderFemale", 2]),
                 digits = 2, nsmall = 2
          )
        )
      })
    ) %>%
    mutate(OR_CI = paste0(OR, " (", CI, ")")) %>%
    select(Division, OR_CI)
  return(tmp)
}

tokable <- as.data.frame(results_summary_table(unadjusted_fit_recent))
tokable_adjusted <- as.data.frame(results_summary_table(adjusted_fit_recent))

tokable %>%
  left_join(tokable_adjusted, by = "Division") %>%
  kable(
    booktabs = TRUE,
    col.names = c(
      "Domaine de recherche", "RC non ajusté (95% IC)",
      "RC ajusté (95% IC)"
    ),
    caption = ""
  ) %>%
  kable_styling(
    position = "center",
    htmltable_class = "lightable-striped",
    html_font = "\"Source Sans Pro\""
  ) %>%
  kable_paper(
    latex_options = c("striped", "hold_position"),
    html_font = "\"Source Sans Pro\""
  )
```

</div>

Autres faits intéressants : les graphiques ci-dessous montrent le rapport des chances et leur intervalle de confiance respectif à 95 % dans le temps pour chaque domaine de recherche, avec et sans prise en compte des variables confondantes. Il convient de noter que les rapports des chances associés au genre varient dans le temps. Il apparaît que, dans les disciplines SHS et SV, les rapports de des chances non ajustés penchent presque toujours en faveur des requérants chargés de la correspondance. Nous constatons également que, dans les disciplines MINT, le rapport des chances penchait en faveur des hommes, mais que cette tendance s’est inversée au fil du temps. Les corrections apportées par les variables confondantes influencent désormais certains résultats. Par exemple, nous observons maintenant que les requérants chargés de la correspondance étaient légèrement moins favorisés dans les disciplines SV.

```{r prep_models_decision_year}
# Recoding of levels for gender and code CallDecisionYear as factor variable
data_gm_up_to_year_of_interest <- data_gm_up_to_year_of_interest %>%
  mutate(
    Gender = factor(Gender, levels = c("Male", "Female")),
    CallDecisionYear = as.factor(CallDecisionYear)
  )

# Get number of decision years in the dataset
n_years <- data_gm_up_to_year_of_interest %>%
  pull(CallDecisionYear) %>%
  nlevels()

# Set some parameters for the plots
ylim_OR_plot <- c(0.025, 3.0)
axis_ticks_year <- levels(data_gm_up_to_year_of_interest$CallDecisionYear)
ats_year <- 
  seq(1, length(levels(data_gm_up_to_year_of_interest$CallDecisionYear)))
```

```{r models_mixed_unadj_decision_year, warning = FALSE, cache=FALSE}
# Computation of models for odds ratio trends (unadjusted)
all_unadjusted_div1_mixed_year <-
  lme4::glmer(
    IsApproved ~ CallDecisionYear * Gender +
      (1 | ApplicantId_Masked),
    family = "binomial",
    data = subset(data_gm_up_to_year_of_interest,
                  Division == "SHS"),
    control = glmerControl(optimizer = "bobyqa",
                           optCtrl = list(maxfun = 2e6))
  )

all_unadjusted_div2_mixed_year <-
  lme4::glmer(
    IsApproved ~ CallDecisionYear * Gender +
      (1 | ApplicantId_Masked),
    family = "binomial",
    data = subset(data_gm_up_to_year_of_interest, Division == "MINT"),
    control = glmerControl(optimizer = "bobyqa",
                           optCtrl = list(maxfun = 2e6))
  )

all_unadjusted_div3_mixed_year <-
  lme4::glmer(
    IsApproved ~ CallDecisionYear * Gender +
      (1 | ApplicantId_Masked),
    family = "binomial",
    data = subset(data_gm_up_to_year_of_interest,
                  Division == "SV"),
    control = glmerControl(optimizer = "bobyqa",
                           optCtrl = list(maxfun = 2e6))
  )

# Plot the 4 OR plots with base R (...), either in mobile version (1 column) or
# in desktop version (2 columns)
plot_or_trends_1 <- function(vers = "desktop") {
  mfrow_setting <- c(2, 2)
  if (vers == "mobile") {
    mfrow_setting <- c(3, 1)
  }
  
  # Create and arrange the trend plots
  par(mfrow = mfrow_setting, las = 2, mar = c(4, 4, 2, 1))
  
  plot_OR_trends(
    model = all_unadjusted_div1_mixed_year,
    dummy_variables = 1,
    number_years = n_years,
    ylim = ylim_OR_plot,
    ylab = "Rapport des chances",
    xlab = "",
    axisticks = axis_ticks_year,
    at = ats_year,
    col = get_datastory_scheme()[2],
    print = FALSE, mixed = TRUE, ci = TRUE,
    title = "SHS"
  )
  
  plot_OR_trends(
    model = all_unadjusted_div2_mixed_year,
    dummy_variables = 1,
    number_years = n_years,
    ylim = ylim_OR_plot,
    ylab = "Rapport des chances",
    xlab = "",
    axisticks = axis_ticks_year,
    at = ats_year,
    col = get_datastory_scheme()[1],
    print = FALSE, mixed = TRUE, ci = TRUE,
    title = "MINT"
  )
  
  plot_OR_trends(
    model = all_unadjusted_div3_mixed_year,
    dummy_variables = 1,
    number_years = n_years,
    ylim = ylim_OR_plot,
    ylab = "Rapport des chances",
    xlab = "",
    axisticks = axis_ticks_year,
    at = ats_year,
    col = get_datastory_scheme()[4],
    print = FALSE, mixed = TRUE, ci = TRUE,
    title = "SV"
  )
}
```

```{r models_mixed_adj_decision_year, warning = FALSE, message = FALSE, cache=FALSE}
# Computation of models for odds ratio trends (adjusted)
form <- sapply(
  list(
    confounders_odds_ssh,
    confounders_odds_mint,
    confounders_odds_ls
  ),
  function(conf) {
    # The age variable has to be scaled to be included in the model
    paste0(
      "IsApproved ~ CallDecisionYear * Gender +",
      paste0(conf, collapse = " + "),
      " + (1 | ApplicantId_Masked)"
    )
  }
)

all_ext_adj_div1_mixed_year <-
  lme4::glmer(form[1],
              family = "binomial",
              data = subset(data_gm_up_to_year_of_interest, Division == "SHS"),
              control = glmerControl(
                optimizer = "bobyqa",
                optCtrl = list(maxfun = 2e6)
              )
  )

all_ext_adj_div2_mixed_year <-
  lme4::glmer(form[2],
              family = "binomial",
              data = subset(data_gm_up_to_year_of_interest, Division == "MINT"),
              control = glmerControl(
                optimizer = "bobyqa",
                optCtrl = list(maxfun = 2e6)
              )
  )

all_ext_adj_div3_mixed_year <-
  lme4::glmer(form[3],
              family = "binomial",
              data = subset(data_gm_up_to_year_of_interest, Division == "SV"),
              control = glmerControl(
                optimizer = "bobyqa",
                optCtrl = list(maxfun = 2e6)
              )
  )

# Plot the 4 OR plots with base R (...), either in mobile version (1 column) or
# in desktop version (2 columns)
plot_or_trends_2 <- function(vers = "desktop") {
  mfrow_setting <- c(2, 2)
  if (vers == "mobile") {
    mfrow_setting <- c(3, 1)
  }
  
  # Plot the estimated odds ratio over time
  par(mfrow = mfrow_setting, las = 2, mar = c(4, 4, 2, 1))
  
  dummy_variables_adj <- c(1, rep(0, 5))
  
  plot_OR_trends(
    model = all_ext_adj_div1_mixed_year,
    dummy_variables = dummy_variables_adj,
    ylim = ylim_OR_plot,
    number_years = n_years,
    ylab = "Rapport des chances",
    xlab = "",
    axisticks = axis_ticks_year,
    at = ats_year,
    col = get_datastory_scheme()[2],
    print = FALSE, mixed = TRUE, ci = TRUE,
    title = "SHS"
  )
  
  plot_OR_trends(
    model = all_ext_adj_div2_mixed_year,
    dummy_variables = dummy_variables_adj,
    ylim = ylim_OR_plot,
    number_years = n_years,
    ylab = "Rapport des chances",
    xlab = "",
    axisticks = axis_ticks_year,
    at = ats_year,
    col = get_datastory_scheme()[1],
    print = FALSE, mixed = TRUE, ci = TRUE,
    title = "MINT"
  )
  
  plot_OR_trends(
    model = all_ext_adj_div3_mixed_year,
    dummy_variables = dummy_variables_adj,
    ylim = ylim_OR_plot,
    number_years = n_years,
    ylab = "Rapport des chances",
    xlab = "",
    axisticks = axis_ticks_year,
    at = ats_year,
    col = get_datastory_scheme()[4],
    print = FALSE, mixed = TRUE, ci = TRUE,
    title = "SV"
  )
}
```

<div class="hide-mobile hide-tablet widemedia">

<div class="plot-box">
<div class="plot-title">Rapport des chances non ajusté associé au genre des requérant·es dans le temps</div>

```{r plot-OR-trends-unadj-desktop, cache=FALSE}
# Show the graph for desktop
plot_or_trends_1("desktop")
```

<div class="caption">
Rapport des chances non ajusté entre les candidatures féminines et masculines (et IC à 95 %) provenant des modèles de régression logistique mixte dans chaque domaine de recherche pour les années de décision 2014-2022 dans l'encouragement de projets. (Étant donné qu'environ 50-65 % des candidats par domaine de recherche ont postulé plusieurs fois au cours de cette période, nous incluons un intercept aléatoire pour le candidat dans les modèles afin de tenir compte de ce regroupement des données).
</div>
</div>

<div class="plot-box">
<div class="plot-title">Rapport des chances ajusté associé au genre des requérant·es dans le temps</div>

```{r plot-OR-trends-adj-desktop, cache=FALSE}
# Show the graph for desktop
plot_or_trends_2("desktop")
```

<div class="caption">
Rapports des chances entre les genres ajustés pour les requérant-e-s de genre féminin et masculin (IC : 95%) à partir des modèles de régression logistique mixte par domaine de recherche pour les années de décision 2014-2022 dans l'encouragement de projets (étant donné qu'environ 50-65 % des requérant-e-s par domaine de recherche ont déposé plusieurs requêtes durant cette période, le modèle inclut un segment d'axe aléatoire pour le requérant-e afin de tenir compte de cette structure de données).
</div>
</div>

</div>

<div class="hide-desktop">

<div class="plot-box">
<div class="plot-title">Rapport des chances non ajusté associé au genre des requérant·es dans le temps</div>

```{r plot-OR-trends-unadj-mobile, out.width="100%", out.height="100%", fig.height=9}
# Show the graph for mobile
plot_or_trends_1("mobile")
```

<div class="caption">
Rapport des chances non ajusté entre les candidatures féminines et masculines (et IC à 95 %) provenant des modèles de régression logistique mixte dans chaque domaine de recherche pour les années de décision 2014-2022 dans l'encouragement de projets. (Étant donné qu'environ 50-65 % des candidats par domaine de recherche ont postulé plusieurs fois au cours de cette période, nous incluons un intercept aléatoire pour le candidat dans les modèles afin de tenir compte de ce regroupement des données).
</div>
</div>

<div class="plot-box">
<div class="plot-title">Rapport des chances ajusté associé au genre des requérant·es dans le temps</div>

```{r plot-OR-trends-adj-mobile, out.width="100%", out.height="100%", fig.height=9}
# Show the graph for desktop
plot_or_trends_2("mobile")
```

<div class="caption">
Rapports des chances entre les genres ajustés pour les requérant-e-s de genre féminin et masculin (IC : 95%) à partir des modèles de régression logistique mixte par domaine de recherche pour les années de décision 2014-2022 dans l'encouragement de projets (étant donné qu'environ 50-65 % des requérant-e-s par domaine de recherche ont déposé plusieurs requêtes durant cette période, le modèle inclut un segment d'axe aléatoire pour le requérant-e afin de tenir compte de cette structure de données).
</div>
</div>

</div>

Nous remarquons dès lors que les variables confondantes susmentionnées ont bel et bien un impact notable sur l’effet du genre observé. Dans divers cas, la portée des effets de genre varie lors d’ajustements au moyen des variables confondantes.

### Poursuite du monitoring au FNS

Pour les deux appels évalués les plus récents, il n'y a pas de preuve statistique d'un biais de genre dans le succès du financement d'une proposition de projet, avec ou sans prise en compte des facteurs de confusion. Néanmoins, lors d’appels précédents, il y avait dans certains cas des preuves en faveur d'un biais de genre favorisant les hommes. Cela met en évidence la nécessité de continuer à assurer un suivi approfondi des questions de genre, adapté aux caractéristiques de chaque programme de financement, et incluant systématiquement tous les facteurs confondants pertinents. Dans le cadre de son gender monitoring régulier, le FNS examine également les notes issues d'évaluations externes réalisées par les pairs et les notes provenant des panels d'évaluation internes. Le FNS examine également les financements reçus par les requérants et requérantes, à la fois de manière descriptive et à l'aide de modèles statistiques. Ces résultats feront l'objet d'un prochain récit de données dans cadre la série sur le gender monitoring.


<div class="info-box">

### SNSF series on gender monitoring

Le FNS analyse systématiquement la proportion de femmes et d’hommes dans ses instruments d’encouragement. Au moyen de ce gender monitoring, nous entendons développer nos méthodes de sélection et notre offre afin de donner aux femmes des chances égales, dans la mesure du possible. Une sélection de données et différents aspects de cette thématique sont mis en lumière dans une série.

<a class="button-blue" href=https://data.snf.ch/stories/femmes-sous-representees-ou-sous-financees-fr.html" target="_blank">(1) la place des femmes dans l’encouragement de projets </a>

<a class="button-blue" href="https://data.snf.ch/stories/plus-la-hierarchie-academique-est-elevee-plus-les-femmes-sont-rares-fr.html" target="_blank">(2) plus la hiérarchie académique est élevée, plus les femmes sont rares</a>

<a class="button-blue" href="https://data.snf.ch/stories/impact-des-variables-confondantes-fr.html" target="_blank">(3, actuelle) les effets des facteurs confondants</a>

</div>


Les données, le texte et le code de ce récit de données sont <a href="https://github.com/snsf-data/datastory_gender_monitoring_confounders" target="_blank">disponibles sur Github</a> et <a href="https://doi.org/10.46446/datastory.gender-monitoring-confounders" target="_blank">archivés sur Zenodo</a>. DOI: 10.46446/datastory.gender-monitoring-confounders